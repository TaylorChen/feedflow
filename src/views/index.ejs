<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeedFlow - å†…å®¹èšåˆä¸ç”Ÿæˆç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/v3.css">
</head>
<body class="page page-home">
    <div class="container">
        <div class="header">
            <div>
                <div class="eyebrow">FeedFlow V3.0</div>
                <h1>FeedFlow</h1>
                <p>RSS å†…å®¹èšåˆä¸æŠ€æœ¯æ–‡ç« ç”Ÿæˆ</p>
            </div>
            <div class="header-actions">
                <div class="btn btn-ghost">æµç¨‹æ¸…æ™° Â· æ“ä½œç›´æ¥</div>
            </div>
        </div>

        <div class="nav">
            <button id="btn-upload" class="primary">
                <strong>æå– RSS åˆ—è¡¨</strong>
                <span>å¯¼å…¥ OPML / æ–‡ä»¶å¹¶å»é‡</span>
            </button>
            <button id="btn-fetch" class="primary">
                <strong>æŠ“å–å†…å®¹</strong>
                <span>é€‰æ‹© RSS æºæŠ“å–æœ€æ–°æ–‡ç« </span>
            </button>
            <button id="btn-analyze-generate" class="primary">
                <strong>åˆ†æ & ç”Ÿæˆæ–‡ç« </strong>
                <span>ç”ŸæˆæŠ€æœ¯ç¬”è®°é£æ ¼è¾“å‡º</span>
            </button>
            <button id="btn-stats">
                <strong>ç»Ÿè®¡ä¿¡æ¯</strong>
                <span>æŸ¥çœ‹æ–‡ç« ä¸åˆ†å¸ƒç»Ÿè®¡</span>
            </button>
            <button id="btn-analysis">
                <strong>AI åˆ†æ</strong>
                <span>æŸ¥çœ‹ä¸»é¢˜æ´å¯Ÿä¸é£é™©</span>
            </button>
            <button id="btn-config">
                <strong>ç³»ç»Ÿé…ç½®</strong>
                <span>APIã€è¾“å‡ºä¸ RSS ç®¡ç†</span>
            </button>
            <button id="btn-cleanup" class="danger">
                <strong>ç³»ç»Ÿæ¸…ç†</strong>
                <span>æ¸…ç†æ— æ•ˆæ–‡ä»¶ä¸ç¼“å­˜</span>
            </button>
        </div>


        <!-- æ–‡ç« é€‰æ‹©åŒºåŸŸ -->
        <div class="articles-section" id="articles-section" style="display: none;">
            <h3>é€‰æ‹©è¦å¤„ç†çš„æ–‡ç« </h3>
            <div class="control-buttons">
                <button id="btn-select-all">å…¨é€‰</button>
                <button id="btn-deselect-all">å–æ¶ˆå…¨é€‰</button>
                <button id="btn-load-articles">åŠ è½½æ–‡ç« </button>
            </div>
            <div class="articles-list" id="articles-list"></div>
            <div class="control-buttons">
                <button id="btn-process-selected">å¤„ç†é€‰ä¸­çš„æ–‡ç« </button>
            </div>
        </div>

        <div class="content">
            <div class="loading" id="loading">
                <p>æ­£åœ¨å¤„ç†...</p>
            </div>

            <div class="message" id="message"></div>


            <!-- æ–‡ç« æ˜ç»†åˆ—è¡¨æ¨¡æ€æ¡† -->
            <div id="articles-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 id="modal-title">æ–‡ç« åˆ—è¡¨</h2>
                    <div id="articles-list-container">
                        <div class="loading" id="articles-loading">
                            <p>æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...</p>
                        </div>
                        <div class="articles-list" id="articles-modal-list"></div>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡† -->
            <div id="upload-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 id="upload-modal-title">æå–RSSåˆ—è¡¨</h2>
                    <div id="upload-container">
                        <div class="upload-section">
                            <h3>æ–‡ä»¶ä¸Šä¼ </h3>
                            <div class="upload-area">
                                <input type="file" id="file-input" accept=".txt,.html,.xml,.json,.opml" style="display: none;">
                                <label for="file-input" class="file-label">
                                    <div class="upload-icon">ğŸ“</div>
                                    <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                                    <div class="upload-hint">æ”¯æŒ .txt, .html, .xml, .json æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</div>
                                </label>
                            </div>
                            <div id="file-info" style="display: none; margin-top: 15px;"></div>
                        </div>


                        <div class="upload-section">
                            <h3>è§£æç»“æœ</h3>
                            <div id="upload-results" style="display: none;">
                                <div class="results-summary"></div>
                                <div class="results-list"></div>
                                <div class="import-controls" style="margin-top: 20px;">
                                    <button id="btn-select-all-feeds">å…¨é€‰</button>
                                    <button id="btn-deselect-all-feeds">å–æ¶ˆå…¨é€‰</button>
                                    <button id="btn-import-selected">å¯¼å…¥é€‰ä¸­çš„RSSæº</button>
                                </div>
                            </div>
                        </div>

                        <div class="control-buttons">
                            <button id="btn-upload-close">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RSSæºé€‰æ‹©æ¨¡æ€æ¡† -->
            <div id="rss-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 id="rss-modal-title">é€‰æ‹©è¦æŠ“å–çš„RSSæº</h2>
                    <div id="rss-list-container">
                        <div class="loading" id="rss-loading">
                            <p>æ­£åœ¨åŠ è½½RSSæºåˆ—è¡¨...</p>
                        </div>
                        <div class="rss-list" id="rss-modal-list"></div>
                        <div class="control-buttons">
                            <button id="btn-select-all-rss">å…¨é€‰</button>
                            <button id="btn-deselect-all-rss">å–æ¶ˆå…¨é€‰</button>
                            <button id="btn-fetch-selected">æŠ“å–é€‰ä¸­çš„RSSæº</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div id="progress-container" class="progress-container">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div class="progress-info">
                    <span id="progress-step" class="progress-step">å‡†å¤‡ä¸­...</span>
                    <span id="progress-percentage" class="progress-percentage">0%</span>
                </div>
            </div>

            <!-- ä»»åŠ¡çŠ¶æ€ -->
            <div id="task-status" class="task-status">
                <div class="task-header">
                    <span id="task-id" class="task-id"></span>
                    <span id="task-status-badge" class="task-status-badge pending">å¾…å¤„ç†</span>
                </div>
                <div id="task-steps" class="task-steps"></div>
                <div id="task-actions" class="task-actions">
                    <button id="btn-cancel-task" disabled>å–æ¶ˆä»»åŠ¡</button>
                </div>
            </div>

            <div class="reports">
                <h2>æœ€è¿‘æŠ¥å‘Š</h2>
                <div class="reports-toolbar">
                    <input type="text" id="report-search" placeholder="æœç´¢æŠ¥å‘Šï¼ˆæ—¶é—´/æ–‡ä»¶å/æ•°é‡ï¼‰">
                </div>
                <ul class="report-list" id="report-list">
                    <% if (reports) { %>
                        <% reports.forEach(report => { %>
                            <li class="report-item" data-filename="<%= report.filename %>">
                                <div class="report-content">
                                    <div class="filename"><%= report.filename %></div>
                                    <div class="info">
                                        æ‰§è¡Œæ—¶é—´: <%= report.startTime %> |
                                        æ‰§è¡Œæ—¶é•¿: <%= report.duration %> |
                                        ç”Ÿæˆåšå®¢: <%= report.generatedBlogs %>
                                    </div>
                                </div>
                                <button class="delete-report" data-filename="<%= report.filename %>">åˆ é™¤</button>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li class="report-item">å°šæœªç”ŸæˆæŠ¥å‘Š</li>
                    <% } %>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const btnFetch = document.getElementById('btn-fetch');
        const btnAnalyzeGenerate = document.getElementById('btn-analyze-generate');
        const btnUpload = document.getElementById('btn-upload');
        const btnStats = document.getElementById('btn-stats');
        const btnAnalysis = document.getElementById('btn-analysis');
        const btnCleanup = document.getElementById('btn-cleanup');
        const btnSelectAll = document.getElementById('btn-select-all');
        const btnDeselectAll = document.getElementById('btn-deselect-all');
        const btnLoadArticles = document.getElementById('btn-load-articles');
        const btnProcessSelected = document.getElementById('btn-process-selected');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const reportList = document.getElementById('report-list');
        const reportSearchInput = document.getElementById('report-search');
        const articlesSection = document.getElementById('articles-section');
        const articlesList = document.getElementById('articles-list');
        let runtimeDefaults = {
            aiModel: 'default',
            outputStyle: 'wechat',
            outputDir: '',
            articleCount: 1
        };

        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å…ƒç´ 
        const uploadModal = document.getElementById('upload-modal');
        const fileInput = document.getElementById('file-input');
        const btnUploadClose = document.getElementById('btn-upload-close');
        const fileInfo = document.getElementById('file-info');
        const uploadResults = document.getElementById('upload-results');

        // è¿›åº¦ç›¸å…³å…ƒç´ 
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressStep = document.getElementById('progress-step');
        const progressPercentage = document.getElementById('progress-percentage');
        const taskStatus = document.getElementById('task-status');
        const taskId = document.getElementById('task-id');
        const taskStatusBadge = document.getElementById('task-status-badge');
        const taskSteps = document.getElementById('task-steps');
        const taskActions = document.getElementById('task-actions');
        const btnCancelTask = document.getElementById('btn-cancel-task');

        // åŠ è½½æœªå¤„ç†çš„æ–‡ç« 
        async function loadUnprocessedArticles() {
            try {
                const response = await fetch('/api/unprocessed-articles');
                const articles = await response.json();

                articlesList.innerHTML = '';

                articles.forEach(article => {
                    const articleItem = document.createElement('div');
                    articleItem.className = 'article-item';
                    articleItem.innerHTML = `
                        <input type="checkbox" value="${article.guid}" id="article-${article.guid}">
                        <div class="article-info">
                            <div class="article-title">${article.title}</div>
                            <div class="article-meta">
                                æ¥æº: ${article.source} | å‘å¸ƒæ—¶é—´: ${article.pubDate}
                            </div>
                        </div>
                    `;

                    const checkbox = articleItem.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            articleItem.classList.add('selected');
                        } else {
                            articleItem.classList.remove('selected');
                        }
                    });

                    articlesList.appendChild(articleItem);
                });

                articlesSection.style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                showMessage('åŠ è½½æ–‡ç« å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…¨é€‰æ‰€æœ‰æ–‡ç« 
        function selectAllArticles() {
            const checkboxes = articlesList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('.article-item').classList.add('selected');
            });
        }

        // å–æ¶ˆå…¨é€‰æ‰€æœ‰æ–‡ç« 
        function deselectAllArticles() {
            const checkboxes = articlesList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.article-item').classList.remove('selected');
            });
        }

        // è·å–é€‰ä¸­çš„æ–‡ç« 
        function getSelectedArticles() {
            const checkboxes = articlesList.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            loading.classList.add('show');
            progressContainer.classList.remove('show');
            taskStatus.classList.remove('show');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            loading.classList.remove('show');
        }

        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress() {
            loading.classList.remove('show');
            progressContainer.classList.add('show');
            taskStatus.classList.add('show');
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percentage, step) {
            progressFill.style.width = `${percentage}%`;
            progressPercentage.textContent = `${percentage}%`;
            if (step) {
                progressStep.textContent = step;
            }
        }

        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        function updateTaskStatus(task) {
            taskId.textContent = task.id;
            taskStatusBadge.textContent = task.status;
            taskStatusBadge.className = `task-status-badge ${task.status}`;

            // æ›´æ–°ä»»åŠ¡æ­¥éª¤
            taskSteps.innerHTML = '';
            task.steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'task-step';
                stepDiv.textContent = `${step.step}: ${step.message}`;
                taskSteps.appendChild(stepDiv);
            });

            // æ›´æ–°å–æ¶ˆæŒ‰é’®çŠ¶æ€
            btnCancelTask.disabled = task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled';
        }

        // å¼€å§‹ä»»åŠ¡è½®è¯¢
        function startTaskPolling(taskId) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (pollTimer) {
                clearInterval(pollTimer);
            }

            // æ˜¾ç¤ºè¿›åº¦æ¡
            showProgress();

            // è½®è¯¢ä»»åŠ¡çŠ¶æ€
            pollTimer = setInterval(async () => {
                try {
                    const response = await fetch(`/api/tasks/${taskId}`);
                    if (!response.ok) {
                        throw new Error('ä»»åŠ¡çŠ¶æ€è¯·æ±‚å¤±è´¥');
                    }

                    const task = await response.json();
                    updateTaskStatus(task);
                    // è·å–å½“å‰æ­¥éª¤ï¼ˆä»stepsæ•°ç»„ä¸­è·å–æœ€åä¸€ä¸ªæ­¥éª¤ï¼‰
                    const currentStep = task.steps.length > 0 ? task.steps[task.steps.length - 1].step : 'å‡†å¤‡ä¸­';
                    updateProgress(task.progress, currentStep);

                    // å¦‚æœä»»åŠ¡å®Œæˆï¼Œæ¸…é™¤å®šæ—¶å™¨
                    if (task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled') {
                        clearInterval(pollTimer);
                        pollTimer = null;

                        if (task.status === 'completed') {
                            showMessage('ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ', 'success');
                            // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯å’ŒæŠ¥å‘Šåˆ—è¡¨
                            updateStats();
                            updateReports();
                        } else if (task.status === 'failed') {
                            showMessage(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${task.error}`, 'error');
                        } else if (task.status === 'cancelled') {
                            showMessage('ä»»åŠ¡å·²å–æ¶ˆ', 'warning');
                        }

                        // å¯ç”¨æŒ‰é’®
                        enableButtons();
                    }
                } catch (error) {
                    console.error('ä»»åŠ¡çŠ¶æ€è½®è¯¢å¤±è´¥:', error);
                    clearInterval(pollTimer);
                    pollTimer = null;
                    showMessage('ä»»åŠ¡çŠ¶æ€è½®è¯¢å¤±è´¥', 'error');
                    enableButtons();
                }
            }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask() {
            if (!taskId.textContent) {
                showMessage('æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId.textContent}/cancel`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('å–æ¶ˆä»»åŠ¡è¯·æ±‚å¤±è´¥');
                }

                const result = await response.json();
                if (result.success) {
                    showMessage('ä»»åŠ¡å·²å–æ¶ˆ', 'warning');
                } else {
                    showMessage(`å–æ¶ˆä»»åŠ¡å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('å–æ¶ˆä»»åŠ¡å¤±è´¥:', error);
                showMessage('å–æ¶ˆä»»åŠ¡å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'message ' + type;
        }

        // éšè—æ¶ˆæ¯
        function hideMessage() {
            message.textContent = '';
            message.className = 'message';
        }

        // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
        function disableButtons() {
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.disabled = true;
            });
        }

        // å¯ç”¨æ‰€æœ‰æŒ‰é’®
        function enableButtons() {
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.disabled = false;
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            // ç»Ÿè®¡ä¿¡æ¯å·²ç§»è‡³ç»Ÿè®¡ä¿¡æ¯é¡µé¢ï¼Œæ­¤å‡½æ•°ä¸å†æ›´æ–°é¦–é¡µç»Ÿè®¡ä¿¡æ¯
            // å¦‚æœéœ€è¦æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ï¼Œè¯·è®¿é—® /stats é¡µé¢
            console.log('ç»Ÿè®¡ä¿¡æ¯å·²ç§»è‡³ç»Ÿè®¡ä¿¡æ¯é¡µé¢');
        }

        // æ›´æ–°æŠ¥å‘Šåˆ—è¡¨
        let reportSearchTimer = null;

        async function updateReports(search = '') {
            try {
                const url = new URL('/api/reports', window.location.origin);
                url.searchParams.set('page', '1');
                url.searchParams.set('pageSize', '10');
                if (search && search.trim().length > 0) {
                    url.searchParams.set('search', search.trim());
                }
                const response = await fetch(url.toString());
                const data = await response.json();
                const reports = Array.isArray(data) ? data : (data.items || []);

                reportList.innerHTML = '';

                if (reports.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'report-item';
                    li.textContent = 'å°šæœªç”ŸæˆæŠ¥å‘Š';
                    reportList.appendChild(li);
                    return;
                }

                reports.forEach(report => {
                    const li = document.createElement('li');
                    li.className = 'report-item';
                    li.dataset.filename = report.filename;

                    li.innerHTML = `
                        <div class="report-content">
                            <div class="filename">${report.filename}</div>
                            <div class="info">
                                æ‰§è¡Œæ—¶é—´: ${report.startTime} |
                                æ‰§è¡Œæ—¶é•¿: ${report.duration} |
                                ç”Ÿæˆåšå®¢: ${report.generatedBlogs}
                            </div>
                        </div>
                        <button class="delete-report" data-filename="${report.filename}">åˆ é™¤</button>
                    `;

                    li.querySelector('.report-content').addEventListener('click', () => {
                        showReportDetails(report.filename);
                    });

                    li.querySelector('.delete-report').addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°liå…ƒç´ 
                        deleteReport(report.filename);
                    });

                    reportList.appendChild(li);
                });
            } catch (error) {
                console.error('æ›´æ–°æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
                showMessage('æ›´æ–°æŠ¥å‘Šåˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadRuntimeDefaults() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error('æ— æ³•è¯»å–ç³»ç»Ÿé…ç½®');
                }
                const config = await response.json();
                runtimeDefaults = {
                    aiModel: config.apiModel || 'default',
                    outputStyle: config.defaultStyle || 'wechat',
                    outputDir: config.outputDir || '',
                    articleCount: Number(config.articlesPerBlog) || 1
                };

                const missing = [];
                if (!config.apiKey) missing.push('APIå¯†é’¥');
                if (!config.outputDir) missing.push('è¾“å‡ºç›®å½•');
                if (!config.imagesDir) missing.push('å›¾ç‰‡ç›®å½•');
                if (missing.length > 0) {
                    showMessage(`ç³»ç»Ÿé…ç½®æœªå®Œæ•´ï¼š${missing.join('ã€')}ï¼Œè¯·åœ¨â€œç³»ç»Ÿé…ç½®â€ä¸­è¡¥é½`, 'error');
                }
            } catch (error) {
                console.error('è¯»å–ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
                showMessage('è¯»å–ç³»ç»Ÿé…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæŠ¥å‘Šè¯¦ç»†å†…å®¹
        async function showReportDetails(filename) {
            try {
                // å°† .json æ–‡ä»¶åæ›¿æ¢ä¸º .html æ–‡ä»¶å
                const htmlFilename = filename.replace('.json', '.html');

                // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ¥æ˜¾ç¤º HTML æŠ¥å‘Š
                const modal = document.createElement('div');
                modal.className = 'modal';

                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';

                const closeBtn = document.createElement('span');
                closeBtn.className = 'close';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => modal.style.display = 'none';

                const iframe = document.createElement('iframe');
                iframe.src = `/data/reports/${htmlFilename}`;
                iframe.width = '100%';
                iframe.height = '600px';
                iframe.style.border = 'none';

                modalContent.appendChild(closeBtn);
                modalContent.appendChild(iframe);
                modal.appendChild(modalContent);

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };

                document.body.appendChild(modal);
                modal.style.display = 'block';

            } catch (error) {
                console.error('è·å–æŠ¥å‘Šè¯¦ç»†å†…å®¹å¤±è´¥:', error);
                showMessage('è·å–æŠ¥å‘Šè¯¦ç»†å†…å®¹å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤æŠ¥å‘Š
        async function deleteReport(filename) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æŠ¥å‘Šå—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/${filename}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('æŠ¥å‘Šåˆ é™¤æˆåŠŸ', 'success');
                    await updateReports();
                } else {
                    showMessage('æŠ¥å‘Šåˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æŠ¥å‘Šå¤±è´¥:', error);
                showMessage('åˆ é™¤æŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰§è¡Œå®Œæ•´å·¥ä½œæµ
        async function executeStart() {
            try {
                showLoading();
                hideMessage();
                disableButtons();

                const options = {
                    aiModel: runtimeDefaults.aiModel,
                    outputStyle: runtimeDefaults.outputStyle,
                    outputDir: runtimeDefaults.outputDir,
                    articleCount: runtimeDefaults.articleCount
                };

                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(options)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('ä»»åŠ¡å·²åˆ›å»º!', 'success');
                    startTaskPolling(result.taskId);
                } else {
                    showMessage('å·¥ä½œæµæ‰§è¡Œå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('æ‰§è¡Œå®Œæ•´å·¥ä½œæµå¤±è´¥:', error);
                showMessage('æ‰§è¡Œå®Œæ•´å·¥ä½œæµå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
                enableButtons();
            }
        }

        // åªæŠ“å–æ–‡ç« 
        async function executeFetch() {
            try {
                showLoading();
                hideMessage();
                disableButtons();

                const response = await fetch('/api/fetch', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showMessage('ä»»åŠ¡å·²åˆ›å»º!', 'success');
                    startTaskPolling(result.taskId);
                } else {
                    showMessage('æ–‡ç« æŠ“å–å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    hideLoading();
                    enableButtons();
                }
            } catch (error) {
                console.error('æŠ“å–æ–‡ç« å¤±è´¥:', error);
                showMessage('æŠ“å–æ–‡ç« å¤±è´¥: ' + error.message, 'error');
                hideLoading();
                enableButtons();
            }
        }

        // åªåˆ†ææ–‡ç« 
        async function executeAnalyzeGenerate() {
            try {
                // æ˜¾ç¤ºæ–‡ç« é€‰æ‹©åŒºåŸŸ
                const articlesSection = document.getElementById('articles-section');
                articlesSection.style.display = 'block';
                showMessage('è¯·é€‰æ‹©è¦åˆ†æå’Œç”Ÿæˆçš„æ–‡ç« ', 'success');

                // åŠ è½½æœªå¤„ç†çš„æ–‡ç« 
                await loadUnprocessedArticles();
            } catch (error) {
                console.error('æ˜¾ç¤ºæ–‡ç« é€‰æ‹©åŒºåŸŸå¤±è´¥:', error);
                showMessage('æ˜¾ç¤ºæ–‡ç« é€‰æ‹©åŒºåŸŸå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¢é‡æ›´æ–°

        // ç³»ç»Ÿæ¸…ç†
        async function executeCleanup() {
            try {
                showLoading();
                hideMessage();
                disableButtons();

                const response = await fetch('/api/cleanup', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showMessage('ç³»ç»Ÿæ¸…ç†æˆåŠŸ!', 'success');
                    await updateStats();
                } else {
                    showMessage('ç³»ç»Ÿæ¸…ç†å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç³»ç»Ÿæ¸…ç†å¤±è´¥:', error);
                showMessage('ç³»ç»Ÿæ¸…ç†å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
                enableButtons();
            }
        }

        // å¤„ç†é€‰ä¸­çš„æ–‡ç« 
        async function processSelectedArticles() {
            try {
                const selectedArticles = getSelectedArticles();

                if (selectedArticles.length === 0) {
                    showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ç¯‡æ–‡ç« ', 'error');
                    return;
                }

                showLoading();
                hideMessage();
                disableButtons();

                // åªä¼ é€’é€‰ä¸­çš„æ–‡ç« ï¼Œå…¶ä»–é…ç½®ä½¿ç”¨é»˜è®¤å€¼
                const options = {
                    selectedArticles: selectedArticles
                };

                const response = await fetch('/api/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(options)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('ä»»åŠ¡å·²åˆ›å»º!', 'success');
                    startTaskPolling(result.taskId);
                } else {
                    showMessage('æ–‡ç« åˆ†æå’Œç”Ÿæˆå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    hideLoading();
                    enableButtons();
                }
            } catch (error) {
                console.error('å¤„ç†é€‰ä¸­çš„æ–‡ç« å¤±è´¥:', error);
                showMessage('å¤„ç†é€‰ä¸­çš„æ–‡ç« å¤±è´¥: ' + error.message, 'error');
                hideLoading();
                enableButtons();
            }
        }

        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬
        btnUpload.addEventListener('click', showUploadModal);
        btnUploadClose.addEventListener('click', closeUploadModal);
        fileInput.addEventListener('change', handleFileSelect);
        btnCancelTask.addEventListener('click', cancelTask);

        // å¯¼å…¥æ§ä»¶äº‹ä»¶ç›‘å¬
        document.getElementById('btn-select-all-feeds').addEventListener('click', selectAllFeeds);
        document.getElementById('btn-deselect-all-feeds').addEventListener('click', deselectAllFeeds);
        document.getElementById('btn-import-selected').addEventListener('click', importSelectedFeeds);

        // è½®è¯¢ä»»åŠ¡è¿›åº¦çš„å®šæ—¶å™¨
        let pollTimer = null;

        // äº‹ä»¶ç›‘å¬
        btnFetch.addEventListener('click', showRSSModal);
        btnAnalyzeGenerate.addEventListener('click', executeAnalyzeGenerate);
        btnStats.addEventListener('click', () => {
            window.location.href = '/stats';
        });
        btnAnalysis.addEventListener('click', () => {
            window.location.href = '/analysis';
        });
        btnCleanup.addEventListener('click', executeCleanup);
        document.getElementById('btn-config').addEventListener('click', () => {
            window.location.href = '/config';
        });

        if (reportSearchInput) {
            reportSearchInput.addEventListener('input', (event) => {
                const value = event.target.value;
                if (reportSearchTimer) {
                    clearTimeout(reportSearchTimer);
                }
                reportSearchTimer = setTimeout(() => updateReports(value), 300);
            });
        }

        // RSSæºé€‰æ‹©æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬ï¼ˆç§»åˆ°showRSSModalå‡½æ•°ä¸­ï¼‰

        // å…³é—­RSSæºé€‰æ‹©æ¨¡æ€æ¡†
        document.querySelector('#rss-modal .close').addEventListener('click', () => {
            document.getElementById('rss-modal').style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­RSSæºé€‰æ‹©æ¨¡æ€æ¡†
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('rss-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        btnSelectAll.addEventListener('click', selectAllArticles);
        btnDeselectAll.addEventListener('click', deselectAllArticles);
        btnLoadArticles.addEventListener('click', loadUnprocessedArticles);
        btnProcessSelected.addEventListener('click', processSelectedArticles);

        // ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶å·²ç§»è‡³ç»Ÿè®¡ä¿¡æ¯é¡µé¢

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤å€¼
        document.addEventListener('DOMContentLoaded', async () => {
            await loadRuntimeDefaults();

            // ä¸ºé¡µé¢åŠ è½½æ—¶æ¸²æŸ“çš„åˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const deleteButtons = document.querySelectorAll('.delete-report');
            deleteButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°liå…ƒç´ 
                    const filename = button.getAttribute('data-filename');
                    deleteReport(filename);
                });
            });

            // ä¸ºé¡µé¢åŠ è½½æ—¶æ¸²æŸ“çš„æŠ¥å‘Šå†…å®¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            const reportItems = document.querySelectorAll('.report-item');
            reportItems.forEach(item => {
                const reportContent = item.querySelector('.report-content');
                if (reportContent) {
                    reportContent.addEventListener('click', () => {
                        const filename = item.getAttribute('data-filename');
                        showReportDetails(filename);
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰ .report-content ç±»ï¼Œç›´æ¥ä¸ºæ•´ä¸ª li å…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    if (!item.textContent.includes('å°šæœªç”ŸæˆæŠ¥å‘Š')) {
                        item.addEventListener('click', () => {
                            const filename = item.getAttribute('data-filename');
                            showReportDetails(filename);
                        });
                    }
                }
            });
        });

        // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡†
        function showUploadModal() {
            uploadModal.style.display = 'block';
            // é‡ç½®è¡¨å•
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadResults.style.display = 'none';
        }

        // å…³é—­æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡†
        function closeUploadModal() {
            uploadModal.style.display = 'none';
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    showMessage('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§ 10MBï¼‰', 'error');
                    fileInput.value = '';
                    return;
                }

                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                fileInfo.textContent = `å·²é€‰æ‹©æ–‡ä»¶: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileInfo.style.display = 'block';

                // ä¸Šä¼ æ–‡ä»¶
                uploadFile(file);
            }
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(file) {
            showLoading();
            hideMessage();

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    displayUploadResults(result.data);
                } else {
                    showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }


        // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
        function displayUploadResults(data) {
            const summaryDiv = uploadResults.querySelector('.results-summary');
            const listDiv = uploadResults.querySelector('.results-list');

            summaryDiv.innerHTML = `
                <p>æ‰¾åˆ° ${data.totalLinks} ä¸ª RSS é“¾æ¥ï¼Œæ–°å¢ ${data.newFeeds} ä¸ªæº</p>
            `;

            listDiv.innerHTML = '';
            data.feeds.forEach(feed => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'result-item';
                itemDiv.innerHTML = `
                    <input type="checkbox" value="${feed.url}" data-name="${feed.name}" data-category="${feed.category}" class="feed-checkbox" ${feed.isExisting ? 'disabled' : ''}>
                    <div class="result-url">${feed.url}</div>
                    <div class="result-info">
                        <strong>åç§°:</strong> ${feed.name} | <strong>åˆ†ç±»:</strong> ${feed.category}
                        ${feed.isExisting ? ' | <span style="color: var(--warning-color);">å·²å­˜åœ¨</span>' : ''}
                    </div>
                `;
                listDiv.appendChild(itemDiv);

                // æ·»åŠ å¤é€‰æ¡†äº‹ä»¶ç›‘å¬
                const checkbox = itemDiv.querySelector('.feed-checkbox');
                if (!feed.isExisting) {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            itemDiv.classList.add('selected');
                        } else {
                            itemDiv.classList.remove('selected');
                        }
                    });
                }
            });

            uploadResults.style.display = 'block';
        }

        // å…¨é€‰æ‰€æœ‰å¯å¯¼å…¥çš„RSSæº
        function selectAllFeeds() {
            const uploadResults = document.getElementById('upload-results');
            const checkboxes = uploadResults.querySelectorAll('.feed-checkbox:not(:disabled)');
            console.log('Select all - Found checkboxes:', checkboxes.length);
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const resultItem = checkbox.closest('.result-item');
                resultItem.classList.add('selected');
                // æ‰‹åŠ¨è§¦å‘ change äº‹ä»¶ï¼Œç¡®ä¿å…¶ä»–äº‹ä»¶ç›‘å¬å™¨è¢«é€šçŸ¥
                const event = new Event('change');
                checkbox.dispatchEvent(event);
            });
        }

        // å–æ¶ˆå…¨é€‰æ‰€æœ‰RSSæº
        function deselectAllFeeds() {
            const uploadResults = document.getElementById('upload-results');
            const checkboxes = uploadResults.querySelectorAll('.feed-checkbox');
            console.log('Deselect all - Found checkboxes:', checkboxes.length);
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const resultItem = checkbox.closest('.result-item');
                resultItem.classList.remove('selected');
                // æ‰‹åŠ¨è§¦å‘ change äº‹ä»¶ï¼Œç¡®ä¿å…¶ä»–äº‹ä»¶ç›‘å¬å™¨è¢«é€šçŸ¥
                const event = new Event('change');
                checkbox.dispatchEvent(event);
            });
        }

        // è·å–é€‰ä¸­çš„RSSæº
        function getSelectedFeeds() {
            const checkboxes = document.querySelectorAll('.feed-checkbox:checked:not(:disabled)');
            return Array.from(checkboxes).map(checkbox => ({
                url: checkbox.value,
                name: checkbox.dataset.name,
                category: checkbox.dataset.category
            }));
        }

        // å¯¼å…¥é€‰ä¸­çš„RSSæº
        async function importSelectedFeeds() {
            const selectedFeeds = getSelectedFeeds();
            if (selectedFeeds.length === 0) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦å¯¼å…¥çš„RSSæº', 'error');
                return;
            }

            showLoading();
            hideMessage();

            try {
                const response = await fetch('/api/import-feeds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ feeds: selectedFeeds })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`æˆåŠŸå¯¼å…¥ ${result.data.importedFeeds.length} ä¸ªRSSæº`, 'success');
                    // é‡ç½®ä¸Šä¼ åŒºåŸŸ
                    fileInput.value = '';
                    urlInput.value = '';
                    fileInfo.style.display = 'none';
                    uploadResults.style.display = 'none';
                } else {
                    showMessage('å¯¼å…¥å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥RSSæºå¤±è´¥:', error);
                showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºRSSæºé€‰æ‹©æ¨¡æ€æ¡†
        async function showRSSModal() {
            const modal = document.getElementById('rss-modal');
            const rssListContainer = document.getElementById('rss-list-container');
            const rssLoading = document.getElementById('rss-loading');
            const rssModalList = document.getElementById('rss-modal-list');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            rssLoading.style.display = 'block';
            rssModalList.innerHTML = '';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';

            try {
                // åŠ è½½RSSæºåˆ—è¡¨ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼‰
                const response = await fetch('/api/rss-feeds?grouped=true');
                const groupedFeeds = await response.json();

                // éšè—åŠ è½½çŠ¶æ€
                rssLoading.style.display = 'none';

                // æ˜¾ç¤ºRSSæºåˆ—è¡¨
                if (groupedFeeds.length === 0) {
                    rssModalList.innerHTML = '<div class="config-hint warning">æœªæ‰¾åˆ°RSSæº</div>';
                    return;
                }

                // ç”Ÿæˆåˆ†ç±»å’ŒRSSæºçš„HTML
                let rssHTML = '';
                groupedFeeds.forEach(group => {
                    rssHTML += `
                        <div class="rss-category">
                            <div class="category-header">
                                <input type="checkbox" class="category-checkbox" id="category-${group.category}">
                                <h4 class="category-title">${group.category} (${group.feeds.length})</h4>
                                <span class="category-toggle">â–¼</span>
                            </div>
                            <div class="category-content">
                                ${group.feeds.map(feed => `
                                    <div class="rss-item">
                                        <input type="checkbox" value="${feed.name}" id="rss-${feed.name}">
                                        <div class="rss-info">
                                            <div class="rss-name">${feed.name}</div>
                                            <div class="rss-url">${feed.url}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                rssModalList.innerHTML = rssHTML;

                // ä¸ºåˆ†ç±»æ ‡é¢˜æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŠ˜å /å±•å¼€ï¼‰
                document.querySelectorAll('.category-header').forEach(header => {
                    const categoryTitle = header.querySelector('.category-title');
                    const categoryToggle = header.querySelector('.category-toggle');
                    const categoryContent = header.nextElementSibling;

                    categoryTitle.addEventListener('click', () => {
                        categoryContent.style.display = categoryContent.style.display === 'none' ? 'block' : 'none';
                        categoryToggle.textContent = categoryContent.style.display === 'none' ? 'â–¶' : 'â–¼';
                    });

                    // ä¸ºåˆ†ç±»å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
                    const categoryCheckbox = header.querySelector('.category-checkbox');
                    categoryCheckbox.addEventListener('change', () => {
                        const isChecked = categoryCheckbox.checked;
                        const categoryFeeds = categoryContent.querySelectorAll('.rss-item input[type="checkbox"]');

                        categoryFeeds.forEach(checkbox => {
                            checkbox.checked = isChecked;
                            const rssItem = checkbox.closest('.rss-item');
                            if (isChecked) {
                                rssItem.classList.add('selected');
                            } else {
                                rssItem.classList.remove('selected');
                            }
                        });
                    });
                });

                // ä¸ºæ¯ä¸ªRSSæºå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
                groupedFeeds.forEach(group => {
                    group.feeds.forEach(feed => {
                        const checkbox = document.getElementById(`rss-${feed.name}`);
                        checkbox.addEventListener('change', () => {
                            const rssItem = checkbox.closest('.rss-item');
                            if (checkbox.checked) {
                                rssItem.classList.add('selected');
                            } else {
                                rssItem.classList.remove('selected');
                            }
                        });
                    });
                });

                // ä¸ºå…¨é€‰ã€å–æ¶ˆå…¨é€‰ã€æŠ“å–é€‰ä¸­æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
                document.getElementById('btn-select-all-rss').addEventListener('click', selectAllRSSFeeds);
                document.getElementById('btn-deselect-all-rss').addEventListener('click', deselectAllRSSFeeds);
                document.getElementById('btn-fetch-selected').addEventListener('click', fetchSelectedRSSFeeds);

            } catch (error) {
                console.error('åŠ è½½RSSæºåˆ—è¡¨å¤±è´¥:', error);
                rssLoading.style.display = 'none';
                rssModalList.innerHTML = `<div class="config-hint warning">åŠ è½½RSSæºåˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨æ¨¡æ€æ¡†
        async function showArticlesList(type) {
            const modal = document.getElementById('articles-modal');
            const modalTitle = document.getElementById('modal-title');
            const articlesListContainer = document.getElementById('articles-list-container');
            const articlesLoading = document.getElementById('articles-loading');
            const articlesModalList = document.getElementById('articles-modal-list');

            // è®¾ç½®æ ‡é¢˜
            if (type === 'all') {
                modalTitle.textContent = 'æ€»æ–‡ç« åˆ—è¡¨';
            } else if (type === 'processed') {
                modalTitle.textContent = 'å·²å¤„ç†æ–‡ç« åˆ—è¡¨';
            } else if (type === 'unprocessed') {
                modalTitle.textContent = 'æœªå¤„ç†æ–‡ç« åˆ—è¡¨';
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            articlesLoading.style.display = 'block';
            articlesModalList.innerHTML = '';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';

            try {
                // åŠ è½½æ–‡ç« åˆ—è¡¨
                let url = '';
                if (type === 'all') {
                    url = '/api/all-articles';
                } else if (type === 'processed') {
                    url = '/api/processed-articles';
                } else if (type === 'unprocessed') {
                    url = '/api/unprocessed-articles';
                }

                const response = await fetch(url);
                const articles = await response.json();

                // éšè—åŠ è½½çŠ¶æ€
                articlesLoading.style.display = 'none';

                // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨
                if (articles.length === 0) {
                    articlesModalList.innerHTML = '<div class="config-hint warning">æœªæ‰¾åˆ°æ–‡ç« </div>';
                    return;
                }

                const articlesHTML = articles.map(article => `
                    <div class="article-item">
                        <div class="article-info">
                            <div class="article-title">${article.title}</div>
                            <div class="article-meta">
                                æ¥æº: ${article.source} | å‘å¸ƒæ—¶é—´: ${article.pubDate}
                            </div>
                        </div>
                    </div>
                `).join('');

                articlesModalList.innerHTML = articlesHTML;
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                articlesLoading.style.display = 'none';
                articlesModalList.innerHTML = `<div class="config-hint warning">åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
        document.querySelector('#upload-modal .close').addEventListener('click', () => {
            uploadModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
        window.addEventListener('click', (event) => {
            if (event.target === uploadModal) {
                uploadModal.style.display = 'none';
            }
        });

        // å…³é—­æ¨¡æ€æ¡†
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('articles-modal').style.display = 'none';
        });

        // å…¨é€‰æ‰€æœ‰RSSæº
        function selectAllRSSFeeds() {
            console.log('selectAllRSSFeeds called');
            const checkboxes = document.querySelectorAll('#rss-modal-list .rss-item input[type="checkbox"]');
            console.log('Found checkboxes:', checkboxes.length);
            checkboxes.forEach(checkbox => {
                console.log('Checkbox ID:', checkbox.id);
                checkbox.checked = true;
                const rssItem = checkbox.closest('.rss-item');
                rssItem.classList.add('selected');
            });
        }

        // å–æ¶ˆå…¨é€‰æ‰€æœ‰RSSæº
        function deselectAllRSSFeeds() {
            console.log('deselectAllRSSFeeds called');
            const checkboxes = document.querySelectorAll('#rss-modal-list .rss-item input[type="checkbox"]');
            console.log('Found checkboxes:', checkboxes.length);
            checkboxes.forEach(checkbox => {
                console.log('Checkbox ID:', checkbox.id);
                checkbox.checked = false;
                const rssItem = checkbox.closest('.rss-item');
                rssItem.classList.remove('selected');
            });
        }

        // è·å–é€‰ä¸­çš„RSSæº
        function getSelectedRSSFeeds() {
            const checkboxes = document.querySelectorAll('#rss-modal-list input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // æŠ“å–é€‰ä¸­çš„RSSæº
        async function fetchSelectedRSSFeeds() {
            const selectedFeeds = getSelectedRSSFeeds();
            if (selectedFeeds.length === 0) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªRSSæº', 'error');
                return;
            }

            showLoading();
            hideMessage();
            disableButtons();

            try {
                const response = await fetch('/api/fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ selectedFeeds })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('ä»»åŠ¡å·²åˆ›å»º', 'success');
                    startTaskPolling(result.taskId);
                    document.getElementById('rss-modal').style.display = 'none';
                } else {
                    showMessage('RSSæºæŠ“å–å¤±è´¥: ' + result.message, 'error');
                    hideLoading();
                    enableButtons();
                }
            } catch (error) {
                console.error('æŠ“å–RSSæºå¤±è´¥:', error);
                showMessage('æŠ“å–RSSæºå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
                enableButtons();
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('articles-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
